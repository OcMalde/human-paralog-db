<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Human Paralog DB</title>
<style>
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:#f5f5fb;min-height:100vh}
.top-bar{position:sticky;top:0;z-index:1000;padding:12px 20px;background:#21244d;color:#fff;box-shadow:0 2px 8px rgba(0,0,0,.25);display:flex;align-items:center;gap:16px;flex-wrap:wrap}
.top-bar h1{margin:0;font-size:18px;font-weight:600;cursor:pointer}
.top-bar h1:hover{opacity:0.9}
.search-box{display:flex;gap:8px;flex:1;min-width:250px;max-width:400px}
.search-box input{flex:1;border:none;border-radius:8px;padding:8px 12px;font-size:14px}
.search-box button{background:#4f46e5;color:#fff;border:none;border-radius:8px;padding:8px 14px;font-size:14px;font-weight:600;cursor:pointer}
.search-box button:hover{background:#4338ca}
.pair-chips{display:flex;gap:6px;flex-wrap:wrap}
.pair-chip{background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.3);color:#fff;padding:4px 10px;border-radius:6px;font-size:12px;cursor:pointer}
.pair-chip:hover{background:rgba(255,255,255,0.25)}
.pair-chip.active{background:#4f46e5;border-color:#4f46e5}
#reportFrame{width:100%;border:none;min-height:calc(100vh - 60px);display:none}
.loading{display:flex;align-items:center;justify-content:center;height:200px;font-size:16px;color:#666}

/* Homepage styles */
.homepage{padding:40px 20px;max-width:900px;margin:0 auto}
.homepage.hidden{display:none}
.hero{text-align:center;margin-bottom:50px}
.hero h2{font-size:32px;color:#21244d;margin:0 0 12px 0}
.hero p{font-size:18px;color:#666;margin:0}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:20px;margin-bottom:50px}
.stat-card{background:#fff;border-radius:12px;padding:24px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.08)}
.stat-value{font-size:36px;font-weight:700;color:#4f46e5;margin-bottom:8px}
.stat-label{font-size:14px;color:#666;text-transform:uppercase;letter-spacing:0.5px}
.examples-section{background:#fff;border-radius:12px;padding:30px;box-shadow:0 2px 8px rgba(0,0,0,0.08)}
.examples-section h3{margin:0 0 20px 0;color:#21244d;font-size:18px}
.example-grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));gap:16px}
.example-category{margin-bottom:20px}
.example-category h4{margin:0 0 12px 0;color:#666;font-size:13px;text-transform:uppercase;letter-spacing:0.5px}
.example-links{display:flex;flex-wrap:wrap;gap:8px}
.example-link{display:inline-block;background:#f0f0ff;color:#4f46e5;padding:8px 14px;border-radius:8px;text-decoration:none;font-size:14px;font-weight:500;transition:all 0.2s}
.example-link:hover{background:#4f46e5;color:#fff}
.example-link .desc{font-size:11px;color:#888;display:block;margin-top:2px}
.example-link:hover .desc{color:rgba(255,255,255,0.8)}
.footer-note{text-align:center;margin-top:40px;padding:20px;color:#888;font-size:13px}
.footer-note a{color:#4f46e5}
</style>
</head>
<body>
<div class="top-bar">
  <h1 onclick="goHome()">Human Paralog DB</h1>
  <div class="search-box">
    <input id="pairInput" type="text" placeholder="Search gene or pair (e.g. ENO1 or ENO1_ENO2)" list="pairOptions" autocomplete="off"/>
    <datalist id="pairOptions"></datalist>
    <button id="loadBtn">Search</button>
  </div>
  <div class="pair-chips" id="pairChips"></div>
</div>

<!-- Homepage -->
<div class="homepage" id="homepage">
  <div class="hero">
    <h2>Human Paralog Database</h2>
    <p>Explore structural and sequence relationships between human paralog gene pairs</p>
  </div>

  <div class="stats-grid" id="statsGrid">
    <div class="stat-card">
      <div class="stat-value" id="statPairs">-</div>
      <div class="stat-label">Paralog Pairs</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="statGenes">-</div>
      <div class="stat-label">Unique Genes</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="statFamilies">-</div>
      <div class="stat-label">Gene Families</div>
    </div>
  </div>

  <div class="examples-section">
    <h3>Example Queries</h3>
    <div class="example-grid">
      <div class="example-category">
        <h4>Search by Gene</h4>
        <div class="example-links" id="geneExamples">
          <!-- Populated dynamically -->
        </div>
      </div>
      <div class="example-category">
        <h4>Search by Pair</h4>
        <div class="example-links" id="pairExamples">
          <!-- Populated dynamically -->
        </div>
      </div>
    </div>
  </div>

  <div class="footer-note">
    This project is in development.
    <a href="https://github.com/OcMalde/human-paralog-db" target="_blank">View on GitHub</a>
  </div>
</div>

<!-- Report iframe (hidden initially) -->
<iframe id="reportFrame" src="about:blank"></iframe>

<script>
let pairs = [];
let families = {};
let familyData = {};
let current = null;

async function init() {
  try {
    // Load pairs data
    const pairsResp = await fetch('./data/index.json');
    pairs = await pairsResp.json();

    // Load family data for statistics
    try {
      const familyResp = await fetch('./data/full_families.json');
      const fullFamilies = await familyResp.json();
      families = fullFamilies.families || {};
      familyData = fullFamilies.family_data || {};
    } catch(e) {
      console.log('Family data not available');
    }

    renderDatalist();
    renderStats();
    renderExamples();

    // Check if we should show a specific pair
    const hash = window.location.hash.slice(1);
    if (hash) {
      loadPair(hash);
    }
    // Otherwise show homepage (default)

  } catch(e) {
    console.error('Init error:', e);
  }
}

function renderStats() {
  // Count unique genes
  const genes = new Set();
  pairs.forEach(p => {
    genes.add(p.geneA);
    genes.add(p.geneB);
  });

  // Count families
  const familyIds = new Set(Object.values(families));

  document.getElementById('statPairs').textContent = pairs.length;
  document.getElementById('statGenes').textContent = genes.size;
  document.getElementById('statFamilies').textContent = familyIds.size || '-';
}

function renderExamples() {
  const geneExamples = document.getElementById('geneExamples');
  const pairExamples = document.getElementById('pairExamples');

  // Pick interesting genes (from different families)
  const exampleGenes = ['ENO1', 'SMARCA2', 'MAGOH', 'STAG1'];
  const availableGenes = exampleGenes.filter(g =>
    pairs.some(p => p.geneA === g || p.geneB === g)
  );

  availableGenes.slice(0, 4).forEach(gene => {
    const link = document.createElement('a');
    link.className = 'example-link';
    link.href = '#';
    link.innerHTML = `${gene}<span class="desc">Find closest pair</span>`;
    link.onclick = (e) => { e.preventDefault(); loadPair(gene); };
    geneExamples.appendChild(link);
  });

  // Pick example pairs with good structural data
  const goodPairs = pairs.filter(p => p.tm && p.tm > 0.5).slice(0, 4);
  goodPairs.forEach(p => {
    const link = document.createElement('a');
    link.className = 'example-link';
    link.href = '#';
    link.innerHTML = `${p.geneA} ↔ ${p.geneB}<span class="desc">${(p.fident * 100).toFixed(0)}% identity</span>`;
    link.onclick = (e) => { e.preventDefault(); loadPair(p.id); };
    pairExamples.appendChild(link);
  });
}

function renderDatalist() {
  const dl = document.getElementById('pairOptions');
  dl.innerHTML = '';

  // Collect unique gene names
  const genes = new Set();
  pairs.forEach(p => {
    genes.add(p.geneA);
    genes.add(p.geneB);
  });

  // Add gene names first (for single gene search)
  Array.from(genes).sort().forEach(gene => {
    const opt = document.createElement('option');
    opt.value = gene;
    dl.appendChild(opt);
  });

  // Then add pair IDs
  pairs.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.id;
    dl.appendChild(opt);
  });
}

function renderChips() {
  const c = document.getElementById('pairChips');
  c.innerHTML = '';

  if (!current) return;

  // Show current + a few related pairs
  let chipsToShow = [];
  const currentPair = pairs.find(p => p.id === current);
  if (currentPair) chipsToShow.push(currentPair);

  // Add related pairs (same genes)
  const relatedPairs = pairs.filter(p =>
    p.id !== current &&
    (p.geneA === currentPair?.geneA || p.geneA === currentPair?.geneB ||
     p.geneB === currentPair?.geneA || p.geneB === currentPair?.geneB)
  ).slice(0, 3);
  chipsToShow.push(...relatedPairs);

  // Fill with random if needed
  if (chipsToShow.length < 4) {
    const others = pairs.filter(p => !chipsToShow.find(c => c.id === p.id));
    const shuffled = others.sort(() => Math.random() - 0.5);
    while (chipsToShow.length < 4 && shuffled.length > 0) {
      chipsToShow.push(shuffled.shift());
    }
  }

  chipsToShow.forEach(p => {
    const chip = document.createElement('span');
    chip.className = 'pair-chip' + (p.id === current ? ' active' : '');
    chip.textContent = `${p.geneA}↔${p.geneB}`;
    chip.onclick = () => loadPair(p.id);
    c.appendChild(chip);
  });
}

function loadPair(id) {
  const input = id.trim();

  // Try exact pair match first
  let p = pairs.find(x => x.id === input || x.id.toLowerCase() === input.toLowerCase());

  // If not found, check if it's a single gene name
  if (!p) {
    const gene = input.toUpperCase();
    const matching = pairs.filter(x =>
      x.geneA.toUpperCase() === gene || x.geneB.toUpperCase() === gene
    );

    if (matching.length > 0) {
      // Pick the pair with highest fident (closest pair)
      p = matching.reduce((best, curr) => {
        const bestIdent = best.fident || 0;
        const currIdent = curr.fident || 0;
        return currIdent > bestIdent ? curr : best;
      }, matching[0]);
    }
  }

  if (!p) {
    alert(`No pair found for "${input}"`);
    return;
  }

  current = p.id;
  document.getElementById('pairInput').value = p.id;
  window.location.hash = p.id;

  // Hide homepage, show report
  document.getElementById('homepage').classList.add('hidden');
  document.getElementById('reportFrame').style.display = 'block';
  document.getElementById('reportFrame').src = `report.html?pair=${encodeURIComponent(p.id)}`;

  renderChips();
}

function goHome() {
  current = null;
  window.location.hash = '';
  document.getElementById('pairInput').value = '';
  document.getElementById('homepage').classList.remove('hidden');
  document.getElementById('reportFrame').style.display = 'none';
  document.getElementById('reportFrame').src = 'about:blank';
  document.getElementById('pairChips').innerHTML = '';
}

// Handle browser back/forward
window.addEventListener('hashchange', () => {
  const hash = window.location.hash.slice(1);
  if (hash) {
    if (hash !== current) loadPair(hash);
  } else {
    goHome();
  }
});

document.getElementById('loadBtn').onclick = () => loadPair(document.getElementById('pairInput').value);
document.getElementById('pairInput').onkeydown = e => { if (e.key === 'Enter') loadPair(e.target.value); };

init();
</script>
</body>
</html>
